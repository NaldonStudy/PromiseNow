<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-critical { background-color: #F44336; }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Redis ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
            <p>ì‹¤ì‹œê°„ ì„±ëŠ¥ ì§€í‘œ ë° í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ (í¬íŠ¸: 8085)</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="avgLatency">--</div>
                <div class="metric-label">í‰ê·  ì§€ì—°ì‹œê°„</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="p99Latency">--</div>
                <div class="metric-label">P99 ì§€ì—°ì‹œê°„</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="throughput">--</div>
                <div class="metric-label">ì²˜ë¦¬ëŸ‰ (ops/sec)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="errorRate">--</div>
                <div class="metric-label">ì—ëŸ¬ìœ¨</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="memoryUsage">--</div>
                <div class="metric-label">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="connectionCount">--</div>
                <div class="metric-label">ì—°ê²° ìˆ˜</div>
            </div>
        </div>

        <div class="chart-container">
            <h3>ğŸ“Š ì„±ëŠ¥ íŠ¸ë Œë“œ</h3>
            <canvas id="performanceChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container">
            <h3>ğŸ”¥ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
            <canvas id="loadTestChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container">
            <h3>ğŸ¯ í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„</h3>
            <div id="clusteringAnalysis">
                <p>ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                <button class="btn" onclick="runClusterAnalysis()">í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ì‹¤í–‰</button>
                <button class="btn" onclick="runLoadTest()">ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <script>
        let performanceChart, loadTestChart;
        let performanceData = {
            labels: [],
            latencies: [],
            throughputs: [],
            errorRates: []
        };

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initCharts() {
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: performanceData.labels,
                    datasets: [{
                        label: 'í‰ê·  ì§€ì—°ì‹œê°„ (ms)',
                        data: performanceData.latencies,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'ì²˜ë¦¬ëŸ‰ (ops/sec)',
                        data: performanceData.throughputs,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            const loadTestCtx = document.getElementById('loadTestChart').getContext('2d');
            loadTestChart = new Chart(loadTestCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì²˜ë¦¬ëŸ‰ (ops/sec)',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 1
                    }, {
                        label: 'ì—ëŸ¬ìœ¨ (%)',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ì„±ëŠ¥ ì§€í‘œ ì—…ë°ì´íŠ¸
        async function updateMetrics() {
            try {
                const response = await fetch('/api/monitoring/redis/performance');
                const data = await response.json();
                
                if (data.success) {
                    const metrics = data.data;
                    
                    document.getElementById('avgLatency').textContent = 
                        metrics.averageLatency ? `${metrics.averageLatency.toFixed(2)}ms` : '--';
                    document.getElementById('p99Latency').textContent = 
                        metrics.p99Latency ? `${metrics.p99Latency.toFixed(2)}ms` : '--';
                    document.getElementById('throughput').textContent = 
                        metrics.totalOperations ? `${metrics.totalOperations.toFixed(0)}` : '--';
                    document.getElementById('errorRate').textContent = 
                        metrics.errorRate ? `${(metrics.errorRate * 100).toFixed(2)}%` : '--';
                    document.getElementById('memoryUsage').textContent = 
                        metrics.memoryUsageBytes ? `${(metrics.memoryUsageBytes / 1024 / 1024).toFixed(1)}MB` : '--';
                    document.getElementById('connectionCount').textContent = 
                        metrics.connectionCount || '--';

                    // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const now = new Date().toLocaleTimeString();
                    performanceData.labels.push(now);
                    performanceData.latencies.push(metrics.averageLatency || 0);
                    performanceData.throughputs.push(metrics.totalOperations || 0);
                    performanceData.errorRates.push(metrics.errorRate || 0);

                    // ìµœê·¼ 20ê°œ ë°ì´í„°ë§Œ ìœ ì§€
                    if (performanceData.labels.length > 20) {
                        performanceData.labels.shift();
                        performanceData.latencies.shift();
                        performanceData.throughputs.shift();
                        performanceData.errorRates.shift();
                    }

                    updatePerformanceChart();
                }
            } catch (error) {
                console.error('ì„±ëŠ¥ ì§€í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì„±ëŠ¥ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updatePerformanceChart() {
            if (performanceChart) {
                performanceChart.data.labels = performanceData.labels;
                performanceChart.data.datasets[0].data = performanceData.latencies;
                performanceChart.data.datasets[1].data = performanceData.throughputs;
                performanceChart.update();
            }
        }

        // í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ì‹¤í–‰
        async function runClusterAnalysis() {
            const analysisDiv = document.getElementById('clusteringAnalysis');
            analysisDiv.innerHTML = '<p>ğŸ” í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ì¤‘...</p>';
            
            try {
                const response = await fetch('/api/monitoring/redis/cluster-analysis', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    const analysis = data.data;
                    displayClusterAnalysis(analysis);
                }
            } catch (error) {
                console.error('í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ì‹¤íŒ¨:', error);
                analysisDiv.innerHTML = '<p>âŒ ë¶„ì„ ì‹¤íŒ¨: ' + error.message + '</p>';
            }
        }

        // ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runLoadTest() {
            const analysisDiv = document.getElementById('clusteringAnalysis');
            analysisDiv.innerHTML = '<p>ğŸ”¥ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</p>';
            
            try {
                const response = await fetch('/api/monitoring/redis/load-test?concurrentUsers=50&operationsPerUser=100&durationSeconds=60', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    displayLoadTestResult(result);
                }
            } catch (error) {
                console.error('ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                analysisDiv.innerHTML = '<p>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message + '</p>';
            }
        }

        // í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayClusterAnalysis(analysis) {
            const analysisDiv = document.getElementById('clusteringAnalysis');
            
            let html = '<h4>ğŸ“ˆ í´ëŸ¬ìŠ¤í„°ë§ ë¶„ì„ ê²°ê³¼</h4>';
            html += `<p><strong>ë¶„ì„ ë‚ ì§œ:</strong> ${analysis.analysisDate}</p>`;
            html += `<p><strong>í´ëŸ¬ìŠ¤í„°ë§ í•„ìš”:</strong> ${analysis.needsClustering ? 'âœ… í•„ìš”' : 'âŒ ë¶ˆí•„ìš”'}</p>`;
            
            if (analysis.needsClustering && analysis.expectedBenefits) {
                const benefits = analysis.expectedBenefits;
                html += '<h5>ğŸ¯ ì˜ˆìƒ íš¨ê³¼</h5>';
                html += `<p>â€¢ ì²˜ë¦¬ëŸ‰ ê°œì„ : ${benefits.expectedThroughput.toFixed(0)} ops/sec</p>`;
                html += `<p>â€¢ ì§€ì—°ì‹œê°„ ê°œì„ : ${benefits.expectedLatency.toFixed(2)}ms</p>`;
                html += `<p>â€¢ ì—ëŸ¬ìœ¨ ê°œì„ : ${(benefits.expectedErrorRate * 100).toFixed(2)}%</p>`;
                html += `<p>â€¢ ì˜ˆìƒ ë¹„ìš© ì ˆê°: ì›” ${benefits.estimatedCostSavings.toFixed(0)}ì›</p>`;
                html += `<p>â€¢ ê¶Œì¥ í´ëŸ¬ìŠ¤í„° í¬ê¸°: ${benefits.recommendedClusterSize}ëŒ€</p>`;
            }
            
            analysisDiv.innerHTML = html;
        }

        // ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
        function displayLoadTestResult(result) {
            const analysisDiv = document.getElementById('clusteringAnalysis');
            
            let html = '<h4>ğŸ”¥ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h4>';
            html += `<p><strong>ì´ ì‘ì—…:</strong> ${result.totalOperations}</p>`;
            html += `<p><strong>ì„±ê³µ:</strong> ${result.successfulOperations}</p>`;
            html += `<p><strong>ì‹¤íŒ¨:</strong> ${result.failedOperations}</p>`;
            html += `<p><strong>í‰ê·  ì§€ì—°ì‹œê°„:</strong> ${result.averageLatency.toFixed(2)}ms</p>`;
            html += `<p><strong>P99 ì§€ì—°ì‹œê°„:</strong> ${result.p99Latency.toFixed(2)}ms</p>`;
            html += `<p><strong>ì²˜ë¦¬ëŸ‰:</strong> ${result.throughput.toFixed(2)} ops/sec</p>`;
            html += `<p><strong>ì—ëŸ¬ìœ¨:</strong> ${(result.errorRate * 100).toFixed(2)}%</p>`;
            
            analysisDiv.innerHTML = html;
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateMetrics();
            
            // 30ì´ˆë§ˆë‹¤ ì„±ëŠ¥ ì§€í‘œ ì—…ë°ì´íŠ¸
            setInterval(updateMetrics, 30000);
        });
    </script>
</body>
</html>
